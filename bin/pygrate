#! /usr/bin/python

import pygrate.loader
import pygrate.database
import pygrate.pygrator
from pygrate.pygration_set import PygrationSet
from pygrate.pygresql_connection import PygresqlConnection
import optparse
import os.path
import sys
import types


def run_main():
    usage = "usage: %prog [options] operation migration"
    parser = optparse.OptionParser( usage=usage )
    parser.add_option( "-p", "--path" )
    parser.add_option( "-v", "--verbose" )

    opts, args = parser.parse_args()

    verbose = True
 
    if len(args) == 0:
        parser.error("A migration set must be specified")
    if len(args) == 1:
        parser.error("An operation must be specified")
    if len(args) > 2:
        parser.error("Too many arguments")

    migration = args[0]
    operation = args[1]

    path = '.'
    if opts.path:
        print "opts.path="+ opts.path
        path = opts.path

    conf_file = open('pygrate.yaml')
    db_file = open('database.d/dev.yaml')
    conf = pygrate.database.Config()
    conf.load(conf_file, db_file)

    # db = pygrate.database.open( path )
    db = PygresqlConnection(conf.db_opts)

    loader = pygrate.loader.PygrationLoader( path, migration )
    loader.load()

    set = PygrationSet( loader.pygrations() )
    p = pygrate.pygrator.Pygrator( db )

    if verbose:
        print "migrate: %s" % operation
    set.migrate( p, operation )

    db.close()


if ( __name__ == "__main__" ):
    run_main()

